<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-time Chorrahani Aniqlovchi Dastur</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map {
      height: 80vh;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h2>Real-time chorraha va yo‘l belgilarini aniqlash</h2>
    <div id="map"></div>
    <p v-if="nearestIntersection">Yaqin chorraha: {{ nearestIntersection }}</p>
    <p v-if="roadSigns.length">Yaqin yo‘l belgilar: {{ roadSigns.join(', ') }}</p>
  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const map = ref(null);
        const userMarker = ref(null);
        const nearestIntersection = ref('');
        const roadSigns = ref([]);

        function haversine(lat1, lon1, lat2, lon2) {
          const R = 6371e3;
          const φ1 = lat1 * Math.PI / 180;
          const φ2 = lat2 * Math.PI / 180;
          const Δφ = (lat2 - lat1) * Math.PI / 180;
          const Δλ = (lon2 - lon1) * Math.PI / 180;

          const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

          return R * c; // in meters
        }

        const demoIntersections = [
          { name: "Chorraha A", lat: 40.386, lon: 71.782 },
          { name: "Chorraha B", lat: 40.3875, lon: 71.780 },
        ];

        const demoSigns = [
          { name: "Stop", lat: 40.3861, lon: 71.7821 },
          { name: "No Entry", lat: 40.3876, lon: 71.7801 },
        ];

        onMounted(() => {
          map.value = L.map('map').setView([40.3864, 71.7821], 15);

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OSM contributors'
          }).addTo(map.value);

          userMarker.value = L.marker([40.3864, 71.7821]).addTo(map.value)
            .bindPopup("Sizning joylashuvingiz").openPopup();

          function updateUserLocation(pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            userMarker.value.setLatLng([lat, lon]);
            map.value.setView([lat, lon]);

            // Yaqin chorrahani aniqlash
            let closest = null;
            let minDist = Infinity;
            for (let i of demoIntersections) {
              const dist = haversine(lat, lon, i.lat, i.lon);
              if (dist < 200 && dist < minDist) {
                closest = i;
                minDist = dist;
              }
            }
            nearestIntersection.value = closest ? closest.name : 'Topilmadi';

            // Yaqin yo‘l belgilarini topish
            roadSigns.value = demoSigns
              .filter(s => haversine(lat, lon, s.lat, s.lon) < 150)
              .map(s => s.name);
          }

          navigator.geolocation.watchPosition(updateUserLocation);
        });

        return { nearestIntersection, roadSigns };
      }
    }).mount('#app');
  </script>
</body>
</html>
